rules_version = '2';

// Craft rules based on data in your Firestore database
// allow write: if firestore.get(

service firebase.storage {
  match /b/{bucket}/o {
    
    // ========== HELPER FUNCTIONS ==========
    
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function isAdmin() {
      return isSignedIn() && 
        firestore.get(/databases/(default)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    function isValidFileType() {
      return request.resource.contentType.matches('image/.*') ||
        request.resource.contentType == 'application/pdf';
    }
    
    function isValidFileSize() {
      return request.resource.size <= 10 * 1024 * 1024; // 10MB max
    }
    
    // ========== TRANSCRIPTS FOLDER ==========
    
    match /transcripts/{userId}/{fileName} {
      // Only owner can access their transcripts
      allow read: if isOwner(userId) || isAdmin();
      
      allow create: if isOwner(userId) &&
        isValidFileType() &&
        isValidFileSize();
      
      allow update: if false; // No updates, only delete and re-upload
      
      allow delete: if isOwner(userId) || isAdmin();
    }
    
    // ========== PROFILE IMAGES ==========
    
    match /profiles/{userId}/{fileName} {
      allow read: if true; // Public profile images
      
      allow create, update: if isOwner(userId) &&
        request.resource.contentType.matches('image/.*') &&
        request.resource.size <= 5 * 1024 * 1024; // 5MB max
      
      allow delete: if isOwner(userId) || isAdmin();
    }
    
    // ========== TEMP UPLOADS ==========
    
    match /temp/{userId}/{fileName} {
      allow create: if isOwner(userId) &&
        isValidFileType() &&
        isValidFileSize();
      
      // Auto-delete after processing (via Cloud Function)
      allow read, delete: if isOwner(userId) || isAdmin();
    }
    
    // ========== ADMIN DOCUMENTS ==========
    
    match /admin/{fileName} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }
    
    // ========== DENY ALL OTHER ==========
    
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}